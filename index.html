<!DOCTYPE html>
<meta charset="utf-8" />
<div>
  <textarea class="text" style="height: 4em; width: 80em;" autofocus></textarea>
</div>
<div><input class="progress" /></div>
<div class="candidate"></div>
<script>
  function canMerge(...codes) {
    return (
      codes.every(c => 0x00 <= c && c <= 0x08) ||
      codes.every(c => 0x0b <= c && c <= 0x1f) ||
      codes.every(c => 0x7f <= c && c <= 0xff) ||
      codes.every(c => "0".codePointAt(0) <= c && c <= "9".codePointAt(0)) ||
      codes.every(c => "A".codePointAt(0) <= c && c <= "Z".codePointAt(0)) ||
      codes.every(c => "a".codePointAt(0) <= c && c <= "z".codePointAt(0))
    );
  }
  function codeToStr(i) {
    if (i === 0x09) return "Tab";
    if (i === 0x0a) return "Enter";
    if (i === 0x20) return "Space";
    if (i < 0x20 || 0x7f <= i) return `0x${i.toString(16).padStart(2, "0")}`;
    return String.fromCodePoint(i);
  }
  function updateCandidates(codeStart, codeLength) {
    let html = "";
    const colCount = codeLength / 4;
    for (let i = 0; i < 4; ++i) {
      html += `<div>${"↑←→↓"[i]}: `;
      let lastCode = null;
      let isMerging = false;
      for (let j = 0; j < colCount; ++j) {
        const code = codeStart + colCount * i + j;
        if (lastCode !== null && canMerge(lastCode, code)) {
          isMerging = true;
        } else {
          html +=
            (isMerging ? `-${codeToStr(lastCode)}` : "") +
            (lastCode !== null ? " " : "") +
            codeToStr(code);
          isMerging = false;
        }
        lastCode = code;
      }
      html += `${isMerging ? `-${codeToStr(lastCode)}` : ""}</div>`;
    }
    document.querySelector(".candidate").innerHTML = html;
  }
  function updateProgress(code2bs) {
    const progress = code2bs.reduce((a, c) => a + "↑←→↓"[c], "");
    document.querySelector(".progress").value = progress;
  }
  let code2bs = [];
  function onKeyDown(e) {
    const arrowKeys = ["ArrowUp", "ArrowLeft", "ArrowRight", "ArrowDown"];
    const idx = arrowKeys.indexOf(e.key);
    if (idx >= 0) {
      code2bs.push(idx);
      e.preventDefault();
    }
    if (e.key === "Escape") {
      code2bs.pop();
      e.preventDefault();
    }
    updateProgress(code2bs);
    let code = code2bs.reduce((a, c, i) => a + c * Math.pow(4, 3 - i), 0);
    if (code2bs.length === 4) {
      document.querySelector(".text").value += String.fromCodePoint(code);
      code = 0;
      code2bs = [];
    }
    updateCandidates(code, 256 / Math.pow(4, code2bs.length));
  }
  onload = () => {
    updateCandidates(0, 256);
    document.querySelector(".text").onkeydown = e => onKeyDown(e);
  };
</script>
